"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@fingerprintjs/fingerprintjs"),t=require("crypto-es"),r=require("js-cookie");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s,n=i(e),c=i(t),o=i(r);!function(e){e.AES="aes",e.DES="des",e.TDES="tdes",e.Rabbit="rabbit",e.RC4="rc4"}(s||(s={}));const a=(e,t)=>{let r=c.default.lib.WordArray.random(16);t&&(r=c.default.enc.Hex.parse(t));const i=((e,t)=>{const r=c.default.PBKDF2(e,t,{keySize:4});return null==r?void 0:r.toString()})(e,r);return{key:i,salt:r.toString(c.default.enc.Hex)}};class l{constructor(e){var t;this._encrypt=c.default.AES.encrypt,this._decrypt=c.default.AES.decrypt,this._isInitialized=!1,this._storage=null!==(t=null===window||void 0===window?void 0:window.localStorage)&&void 0!==t?t:localStorage,this._encryptionSecret={expires:90},this.config={encodingType:s.AES,storageNamespace:"secure"},this.initAsync=async()=>{if(void 0!==this._encryptionSecret.key)return void(this._isInitialized=!0);if(!l.browserFingerPrint){const e=await n.default.load(),t=await e.get();l.browserFingerPrint=t.visitorId,Object.freeze(l.browserFingerPrint)}const e=this.getSaltOrDefaultFromSecurePlace();this.setEncryptionSecret(e),this._isInitialized=!0},this.clear=()=>{for(let e=0;e<this._storage.length;e++){const t=this._storage.key(e);(null==t?void 0:t.startsWith(`${this.config.storageNamespace}.`))&&this._storage.removeItem(t)}},this.getItem=e=>{this.throwIfNotInitialized(),e=this.getNamespaceKey(e);const t=this._storage.getItem(e);if(null===t)return null;const r=this._decrypt(t,this._encryptionSecret.key).toString(c.default.enc.Utf8);try{return JSON.parse(r)}catch(e){return r}},this.removeItem=e=>{e=this.getNamespaceKey(e),this._storage.removeItem(e)},this.setItem=(e,t)=>{this.throwIfNotInitialized(),e=this.getNamespaceKey(e);let r=t;"string"!=typeof t&&(r=JSON.stringify(t));const i=this._encrypt(r,this._encryptionSecret.key);this._storage.setItem(e,i.toString())},this.getNamespaceKey=e=>(this.throwIfKeyIsUndefined(e),`${this.config.storageNamespace}.${e}`),this.setConfig(e),this.setCryptoMethods()}get metaKey(){return`${this.config.storageNamespace}_metaKey`}throwIfNotInitialized(){if(!this._isInitialized)throw new Error("Secure Storage: Is not initialized.")}throwIfKeyIsUndefined(e){if(!e)throw new Error("Secure Storage: a key must be provided.")}setEncryptionSecret(e){if(!l.browserFingerPrint)throw new Error("Secure Storage: Browser finger print is not set.");if(!e){const e=(t=l.browserFingerPrint,a(t));return this.setSaltToSecurePlace(e),this._encryptionSecret.key=e.key,void Object.freeze(this._encryptionSecret)}var t;this._encryptionSecret.key=a(l.browserFingerPrint,e).key,Object.freeze(this._encryptionSecret)}setSaltToSecurePlace(e){o.default.set(this.metaKey,e.salt,{secure:!0,sameSite:"Strict",expires:this._encryptionSecret.expires})}getSaltOrDefaultFromSecurePlace(){return o.default.get(this.metaKey)}setConfig(e){var t,r;this.config.encodingType=null!==(t=null==e?void 0:e.encodingType)&&void 0!==t?t:this.config.encodingType,this.config.storageNamespace=null!==(r=null==e?void 0:e.storageNamespace)&&void 0!==r?r:this.config.storageNamespace,this.setConfigSecret(e)}setConfigSecret(e){void 0!==(null==e?void 0:e.encryptionSecret)&&(this._encryptionSecret=e.encryptionSecret,this._encryptionSecret.key&&Object.freeze(this._encryptionSecret))}setCryptoMethods(){switch(this.config.encodingType){case s.TDES:this._encrypt=c.default.TripleDES.encrypt,this._decrypt=c.default.TripleDES.decrypt;break;case s.DES:this._encrypt=c.default.DES.encrypt,this._decrypt=c.default.DES.decrypt;break;case s.Rabbit:this._encrypt=c.default.Rabbit.encrypt,this._decrypt=c.default.Rabbit.decrypt;break;case s.RC4:this._encrypt=c.default.RC4.encrypt,this._decrypt=c.default.RC4.decrypt;break;case s.AES:this._encrypt=c.default.AES.encrypt,this._decrypt=c.default.AES.decrypt}}}const y=new class{constructor(){this.generateSecretKeyWithSalt=a}async createAsync(e){const t=new l(e);return await t.initAsync(),{clear:t.clear,setItem:t.setItem,getItem:t.getItem,removeItem:t.removeItem}}};exports.SecureStorage=y;
//# sourceMappingURL=secure-storage.cjs.js.map
