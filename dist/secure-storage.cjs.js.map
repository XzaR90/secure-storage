{"version":3,"file":"secure-storage.cjs.js","sources":["../src/index.ts"],"sourcesContent":["import FingerprintJS from '@fingerprintjs/fingerprintjs';\r\nimport CryptoES from 'crypto-es';\r\nimport Cookies from 'js-cookie';\r\nimport { EncodingType } from './enums/EncodingType';\r\nimport generateSecretKey, { generateSecretKeyWithSalt } from './helpers/generateSecretKey';\r\nimport { IEncryptionConfig } from './interfaces/IEncryptionConfig';\r\nimport { ISecureStorage } from './interfaces/ISecureStorage';\r\nimport { ISecureStorageConfig } from './interfaces/ISecureStorageConfig';\r\nimport { ISecureStorageConfigBase } from './interfaces/ISecureStorageConfigBase';\r\nimport { ISecureStorageFactory } from './interfaces/ISecureStorageFactory';\r\n\r\nclass SecureStorage {\r\n    private static browserFingerPrint?: string;\r\n    private _encrypt = CryptoES.AES.encrypt;\r\n    private _decrypt = CryptoES.AES.decrypt;\r\n    private _isInitialized = false;\r\n    private _storage: Storage = window?.localStorage ?? localStorage;\r\n    private _encryptionSecret: IEncryptionConfig = {\r\n        expires: 90,\r\n    };\r\n\r\n    config: ISecureStorageConfigBase = {\r\n        encodingType: EncodingType.AES,\r\n        storageNamespace: 'secure',\r\n    };\r\n\r\n    constructor(config: Partial<ISecureStorageConfig>) {\r\n        this.setConfig(config);\r\n        this.setCryptoMethods();\r\n    }\r\n\r\n    initAsync = async () => {\r\n        if (this._encryptionSecret.key !== undefined) {\r\n            this._isInitialized = true;\r\n            return;\r\n        }\r\n\r\n        if (!SecureStorage.browserFingerPrint) {\r\n            const fp = await FingerprintJS.load();\r\n            const result = await fp.get();\r\n            SecureStorage.browserFingerPrint = result.visitorId;\r\n            Object.freeze(SecureStorage.browserFingerPrint);\r\n        }\r\n\r\n        const salt = this.getSaltOrDefaultFromSecurePlace();\r\n        this.setEncryptionSecret(salt);\r\n        this._isInitialized = true;\r\n    };\r\n\r\n    clear = () => {\r\n        for (let index = 0; index < this._storage.length; index++) {\r\n            const key = this._storage.key(index);\r\n            if (key?.startsWith(`${this.config.storageNamespace}.`)) {\r\n                this._storage.removeItem(key);\r\n            }\r\n        }\r\n    };\r\n\r\n    getItem = <T>(key: string): T | null => {\r\n        this.throwIfNotInitialized();\r\n\r\n        key = this.getNamespaceKey(key);\r\n        const encodedItem = this._storage.getItem(key);\r\n        if (encodedItem === null) {\r\n            return null;\r\n        }\r\n\r\n        const decryptedValue = this._decrypt(encodedItem, this._encryptionSecret.key);\r\n        const strValue = decryptedValue.toString(CryptoES.enc.Utf8);\r\n        try {\r\n            return JSON.parse(strValue);\r\n        } catch (e) {\r\n            return strValue as unknown as T;\r\n        }\r\n    };\r\n\r\n    removeItem = (key: string): void => {\r\n        key = this.getNamespaceKey(key);\r\n        this._storage.removeItem(key);\r\n    };\r\n\r\n    setItem = <T>(key: string, value: T): void => {\r\n        this.throwIfNotInitialized();\r\n\r\n        key = this.getNamespaceKey(key);\r\n        let strValue = value as unknown as string;\r\n        if (typeof value !== 'string') {\r\n            strValue = JSON.stringify(value);\r\n        }\r\n\r\n        const encryptedValue = this._encrypt(strValue, this._encryptionSecret.key);\r\n        this._storage.setItem(key, encryptedValue.toString());\r\n    };\r\n\r\n    private get metaKey() {\r\n        return `${this.config.storageNamespace}_metaKey`;\r\n    }\r\n\r\n    private getNamespaceKey = (key: string) => {\r\n        this.throwIfKeyIsUndefined(key);\r\n        return `${this.config.storageNamespace}.${key}`;\r\n    };\r\n\r\n    private throwIfNotInitialized() {\r\n        if (!this._isInitialized) {\r\n            throw new Error('Secure Storage: Is not initialized.');\r\n        }\r\n    }\r\n\r\n    private throwIfKeyIsUndefined(key: string) {\r\n        if (!key) {\r\n            throw new Error('Secure Storage: a key must be provided.');\r\n        }\r\n    }\r\n\r\n    private setEncryptionSecret(salt: string | undefined) {\r\n        if (!SecureStorage.browserFingerPrint) {\r\n            throw new Error('Secure Storage: Browser finger print is not set.');\r\n        }\r\n\r\n        if (!salt) {\r\n            const secret = generateSecretKey(SecureStorage.browserFingerPrint);\r\n            this.setSaltToSecurePlace(secret);\r\n            this._encryptionSecret.key = secret.key;\r\n            Object.freeze(this._encryptionSecret);\r\n            return;\r\n        }\r\n\r\n        this._encryptionSecret.key = generateSecretKeyWithSalt(SecureStorage.browserFingerPrint, salt).key;\r\n        Object.freeze(this._encryptionSecret);\r\n    }\r\n\r\n    private setSaltToSecurePlace(secret: { key: string; salt: string }) {\r\n        Cookies.set(this.metaKey, secret.salt, {\r\n            secure: true,\r\n            sameSite: 'Strict',\r\n            expires: this._encryptionSecret.expires,\r\n        });\r\n    }\r\n\r\n    private getSaltOrDefaultFromSecurePlace() {\r\n        return Cookies.get(this.metaKey);\r\n    }\r\n\r\n    private setConfig(config: Partial<ISecureStorageConfig>) {\r\n        this.config.encodingType = config?.encodingType ?? this.config.encodingType;\r\n        this.config.storageNamespace = config?.storageNamespace ?? this.config.storageNamespace;\r\n        this.setConfigSecret(config);\r\n    }\r\n\r\n    private setConfigSecret(config: Partial<ISecureStorageConfig>) {\r\n        if (config?.encryptionSecret !== undefined) {\r\n            this._encryptionSecret = config.encryptionSecret;\r\n            if (this._encryptionSecret.key) {\r\n                Object.freeze(this._encryptionSecret);\r\n            }\r\n        }\r\n    }\r\n\r\n    private setCryptoMethods() {\r\n        switch (this.config.encodingType) {\r\n            case EncodingType.TDES:\r\n                this._encrypt = CryptoES.TripleDES.encrypt;\r\n                this._decrypt = CryptoES.TripleDES.decrypt;\r\n                break;\r\n            case EncodingType.DES:\r\n                this._encrypt = CryptoES.DES.encrypt;\r\n                this._decrypt = CryptoES.DES.decrypt;\r\n                break;\r\n            case EncodingType.Rabbit:\r\n                this._encrypt = CryptoES.Rabbit.encrypt;\r\n                this._decrypt = CryptoES.Rabbit.decrypt;\r\n                break;\r\n            case EncodingType.RC4:\r\n                this._encrypt = CryptoES.RC4.encrypt;\r\n                this._decrypt = CryptoES.RC4.decrypt;\r\n                break;\r\n            case EncodingType.AES:\r\n                this._encrypt = CryptoES.AES.encrypt;\r\n                this._decrypt = CryptoES.AES.decrypt;\r\n                break;\r\n        }\r\n    }\r\n}\r\n\r\nclass SecureStorageFactory implements ISecureStorageFactory {\r\n    generateSecretKeyWithSalt = generateSecretKeyWithSalt;\r\n    async createAsync(config: Partial<ISecureStorageConfig>): Promise<ISecureStorage> {\r\n        const secureStorage = new SecureStorage(config);\r\n        await secureStorage.initAsync();\r\n        return {\r\n            clear: secureStorage.clear,\r\n            setItem: secureStorage.setItem,\r\n            getItem: secureStorage.getItem,\r\n            removeItem: secureStorage.removeItem,\r\n        };\r\n    }\r\n}\r\n\r\nexport default new SecureStorageFactory();\r\n"],"names":["CryptoES","EncodingType","FingerprintJS","generateSecretKey","generateSecretKeyWithSalt","Cookies"],"mappings":"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"}