{"version":3,"file":"secure-storage.cjs.js","sources":["../src/enums/EncodingType.ts","../src/helpers/generateSecretKey.ts","../src/index.ts"],"sourcesContent":["export enum EncodingType {\r\n    AES = 'aes',\r\n    DES = 'des',\r\n    TDES = 'tdes',\r\n    Rabbit = 'rabbit',\r\n    RC4 = 'rc4',\r\n}\r\n","import CryptoES from 'crypto-es';\r\nimport { IKeySaltPair } from 'src/interfaces/IKeySaltPair';\r\n\r\nconst _generateSecretKey = (secretPhrase: string, salt: CryptoES.lib.WordArray) => {\r\n    const key128Bits = CryptoES.PBKDF2(secretPhrase, salt, { keySize: 128 / 32 });\r\n    return key128Bits?.toString();\r\n};\r\n\r\nexport const generateSecretKeyWithSalt = (secretPhrase: string, saltAsHex?: string): IKeySaltPair => {\r\n    let salt = CryptoES.lib.WordArray.random(128 / 8);\r\n    if (saltAsHex) {\r\n        salt = CryptoES.enc.Hex.parse(saltAsHex);\r\n    }\r\n\r\n    const key128Bits = _generateSecretKey(secretPhrase, salt);\r\n    return { key: key128Bits, salt: salt.toString(CryptoES.enc.Hex) };\r\n};\r\n\r\nexport const generateSecretKey = (secretPhrase: string) => {\r\n    return generateSecretKeyWithSalt(secretPhrase);\r\n};\r\n","import FingerprintJS from '@fingerprintjs/fingerprintjs';\r\nimport CryptoES from 'crypto-es';\r\nimport Cookies from 'js-cookie';\r\nimport { EncodingType } from './enums/EncodingType';\r\nimport { generateSecretKey, generateSecretKeyWithSalt } from './helpers/generateSecretKey';\r\nimport { IEncryptionConfig } from './interfaces/IEncryptionConfig';\r\nimport { IKeySaltPair } from './interfaces/IKeySaltPair';\r\nimport { ISecureStorage } from './interfaces/ISecureStorage';\r\nimport { ISecureStorageConfig } from './interfaces/ISecureStorageConfig';\r\nimport { ISecureStorageConfigBase } from './interfaces/ISecureStorageConfigBase';\r\nimport { ISecureStorageFactory } from './interfaces/ISecureStorageFactory';\r\n\r\nclass SecureStorage {\r\n    private static browserFingerPrint?: string;\r\n    private _encrypt = CryptoES.AES.encrypt;\r\n    private _decrypt = CryptoES.AES.decrypt;\r\n    private _isInitialized = false;\r\n    private _storage: Storage = window?.localStorage ?? localStorage;\r\n    private _encryptionSecret: IEncryptionConfig = {\r\n        expires: 90,\r\n    };\r\n\r\n    config: ISecureStorageConfigBase = {\r\n        encodingType: EncodingType.AES,\r\n        storageNamespace: 'secure',\r\n    };\r\n\r\n    constructor(config: Partial<ISecureStorageConfig>) {\r\n        this.setConfig(config);\r\n        this.setCryptoMethods();\r\n    }\r\n\r\n    initAsync = async () => {\r\n        if (this._encryptionSecret.key !== undefined) {\r\n            this._isInitialized = true;\r\n            return;\r\n        }\r\n\r\n        if (!SecureStorage.browserFingerPrint) {\r\n            const fp = await FingerprintJS.load();\r\n            const result = await fp.get();\r\n            SecureStorage.browserFingerPrint = result.visitorId;\r\n            Object.freeze(SecureStorage.browserFingerPrint);\r\n        }\r\n\r\n        const salt = this.getSaltOrDefaultFromSecurePlace();\r\n        this.setEncryptionSecret(salt);\r\n        this._isInitialized = true;\r\n    };\r\n\r\n    clear = () => {\r\n        for (let index = 0; index < this._storage.length; index++) {\r\n            const key = this._storage.key(index);\r\n            if (key?.startsWith(`${this.config.storageNamespace}.`)) {\r\n                this._storage.removeItem(key);\r\n            }\r\n        }\r\n    };\r\n\r\n    getItem = <T>(key: string): T | null => {\r\n        this.throwIfNotInitialized();\r\n\r\n        key = this.getNamespaceKey(key);\r\n        const encodedItem = this._storage.getItem(key);\r\n        if (encodedItem === null) {\r\n            return null;\r\n        }\r\n\r\n        const decryptedValue = this._decrypt(encodedItem, this._encryptionSecret.key);\r\n        const strValue = decryptedValue.toString(CryptoES.enc.Utf8);\r\n        try {\r\n            return JSON.parse(strValue);\r\n        } catch (e) {\r\n            return strValue as unknown as T;\r\n        }\r\n    };\r\n\r\n    removeItem = (key: string): void => {\r\n        key = this.getNamespaceKey(key);\r\n        this._storage.removeItem(key);\r\n    };\r\n\r\n    setItem = <T>(key: string, value: T): void => {\r\n        this.throwIfNotInitialized();\r\n\r\n        key = this.getNamespaceKey(key);\r\n        let strValue = value as unknown as string;\r\n        if (typeof value !== 'string') {\r\n            strValue = JSON.stringify(value);\r\n        }\r\n\r\n        const encryptedValue = this._encrypt(strValue, this._encryptionSecret.key);\r\n        this._storage.setItem(key, encryptedValue.toString());\r\n    };\r\n\r\n    private get metaKey() {\r\n        return `${this.config.storageNamespace}_metaKey`;\r\n    }\r\n\r\n    private getNamespaceKey = (key: string) => {\r\n        this.throwIfKeyIsUndefined(key);\r\n        return `${this.config.storageNamespace}.${key}`;\r\n    };\r\n\r\n    private throwIfNotInitialized() {\r\n        if (!this._isInitialized) {\r\n            throw new Error('Secure Storage: Is not initialized.');\r\n        }\r\n    }\r\n\r\n    private throwIfKeyIsUndefined(key: string) {\r\n        if (!key) {\r\n            throw new Error('Secure Storage: a key must be provided.');\r\n        }\r\n    }\r\n\r\n    private setEncryptionSecret(salt: string | undefined) {\r\n        if (!SecureStorage.browserFingerPrint) {\r\n            throw new Error('Secure Storage: Browser finger print is not set.');\r\n        }\r\n\r\n        if (!salt) {\r\n            const secret = generateSecretKey(SecureStorage.browserFingerPrint);\r\n            this.setSaltToSecurePlace(secret);\r\n            this._encryptionSecret.key = secret.key;\r\n            Object.freeze(this._encryptionSecret);\r\n            return;\r\n        }\r\n\r\n        this._encryptionSecret.key = generateSecretKeyWithSalt(SecureStorage.browserFingerPrint, salt).key;\r\n        Object.freeze(this._encryptionSecret);\r\n    }\r\n\r\n    private setSaltToSecurePlace(secret: { key: string; salt: string }) {\r\n        Cookies.set(this.metaKey, secret.salt, {\r\n            secure: true,\r\n            sameSite: 'Strict',\r\n            expires: this._encryptionSecret.expires,\r\n        });\r\n    }\r\n\r\n    private getSaltOrDefaultFromSecurePlace() {\r\n        return Cookies.get(this.metaKey);\r\n    }\r\n\r\n    private setConfig(config: Partial<ISecureStorageConfig>) {\r\n        this.config.encodingType = config?.encodingType ?? this.config.encodingType;\r\n        this.config.storageNamespace = config?.storageNamespace ?? this.config.storageNamespace;\r\n        this.setConfigSecret(config);\r\n    }\r\n\r\n    private setConfigSecret(config: Partial<ISecureStorageConfig>) {\r\n        if (config?.encryptionSecret !== undefined) {\r\n            this._encryptionSecret = config.encryptionSecret;\r\n            if (this._encryptionSecret.key) {\r\n                Object.freeze(this._encryptionSecret);\r\n            }\r\n        }\r\n    }\r\n\r\n    private setCryptoMethods() {\r\n        switch (this.config.encodingType) {\r\n            case EncodingType.TDES:\r\n                this._encrypt = CryptoES.TripleDES.encrypt;\r\n                this._decrypt = CryptoES.TripleDES.decrypt;\r\n                break;\r\n            case EncodingType.DES:\r\n                this._encrypt = CryptoES.DES.encrypt;\r\n                this._decrypt = CryptoES.DES.decrypt;\r\n                break;\r\n            case EncodingType.Rabbit:\r\n                this._encrypt = CryptoES.Rabbit.encrypt;\r\n                this._decrypt = CryptoES.Rabbit.decrypt;\r\n                break;\r\n            case EncodingType.RC4:\r\n                this._encrypt = CryptoES.RC4.encrypt;\r\n                this._decrypt = CryptoES.RC4.decrypt;\r\n                break;\r\n            case EncodingType.AES:\r\n                this._encrypt = CryptoES.AES.encrypt;\r\n                this._decrypt = CryptoES.AES.decrypt;\r\n                break;\r\n        }\r\n    }\r\n}\r\n\r\nclass SecureStorageFactory implements ISecureStorageFactory {\r\n    generateSecretKeyWithSalt: (secretPhrase: string, saltAsHex?: string) => IKeySaltPair = generateSecretKeyWithSalt;\r\n    async createAsync(config: Partial<ISecureStorageConfig>): Promise<ISecureStorage> {\r\n        const secureStorage = new SecureStorage(config);\r\n        await secureStorage.initAsync();\r\n        return {\r\n            clear: secureStorage.clear,\r\n            setItem: secureStorage.setItem,\r\n            getItem: secureStorage.getItem,\r\n            removeItem: secureStorage.removeItem,\r\n        };\r\n    }\r\n}\r\n\r\nconst factory = new SecureStorageFactory();\r\nexport default factory;\r\nexports['default'] = factory;\r\nmodule.exports = exports['default'];\r\n"],"names":["CryptoES","FingerprintJS","Cookies"],"mappings":"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"}